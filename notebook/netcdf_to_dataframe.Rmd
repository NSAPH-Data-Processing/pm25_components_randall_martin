---
title: "Netcdf Data Processing"
output: html_notebook
---

This notebook process raw Netcdf codes from Randall Martin's surface PM2.5 exposure dataset(https://sites.wustl.edu/acag/datasets/surface-pm2-5/)

```{r}
library(ncdf4)
#library(raster)
library(tidyverse)
#library(geometry)
#library(data.table)
#library(maps)
library(magrittr)
library(ggplot2)
library(sf)
library(reshape2) # For reshaping data
#library(mapdata)  # For map data
#library(ggmap)
```

```{r}
grid_sf <- read_sf("../data/input/10km_grid_wgs84/10km_grid_wgs84.shp")

st_crs(grid_sf)

grid_sf %>% 
  ggplot() + 
  geom_sf(fill = "blue", lwd = 0.00)
```


```{r}
nc_file <- nc_open("../data/input/pm25_components/PM25/V4NA03_PM25_NA_200001_200012-RH35.nc")
print(nc_file)
```

```{r}
attributes(nc_file)
```

```{r}
pm25 <- ncvar_get(nc_file, "PM25")
class(pm25)
dim(pm25)
dim(pm25)[1]*dim(pm25)[2]
sum(!is.na(pm25))
sum(is.na(pm25))
```

```{r}
pm25[1:10, 1:10]
```

```{r}
lon <- ncvar_get(nc_file, "LON")
lat <- ncvar_get(nc_file, "LAT")
class(lon)
length(lon)
class(lat)
length(lat)

lon[1:10]
lat[1:10]
```

```{r}
# Reshape data
pm25_df <- melt(pm25)
pm25_df
```

```{r}
pm25_df$lon <- rep(lon, length(lat))
pm25_df$lat <- rep(lat, each = length(lon))
pm25_df
```

```{r}
pm25_df <- pm25_df %>% 
  select(-c(Var1, Var2)) %>% 
  rename(pm25 = value) %>% 
  drop_na(pm25)

dim(pm25_df)
```

```{r}
pm25_df
```

```{r}
pm25_sf <- st_as_sf(pm25_df, coords = c("lon","lat"))
head(pm25_sf)
```

```{r}
st_crs(pm25_sf) <- st_crs(grid_sf)
head(pm25_sf)
```

```{r}
grid_sf %>% 
  ggplot() + 
  geom_sf(fill = "blue", lwd = 0.00) + 
  geom_sf(data = sample_n(pm25_sf, 10000), 
          color = "red", 
          size = 0.5)
```


```{r}

grid_sf %>% 
  ggplot() + 
  geom_sf(fill = "blue", lwd = 0.00) + 
  geom_sf(data = sample_n(pm25_sf, 10000), 
          color = "red", 
          size = 0.5)
grid_sf %>% 
  ggplot() +
  geom_sf(fill = "pink", lwd = 0.00) + 
  geom_sf(data = sample_pm25, aes(color = pm25), size = 0.5) +
  scale_color_distiller(palette = "Spectral")
```


